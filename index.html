<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오.운.완 개인 대시보드</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .login-section input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px;
            width: 250px;
        }

        .login-section button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-section button:hover {
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            height: 400px;
            position: relative;
        }

        .chart-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .recent-activities {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .activity-item:hover {
            background-color: #f8f9ff;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-type {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .streak-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: bold;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }
            
            .login-section input {
                width: 100%;
                max-width: 300px;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏃‍♂️ 오.운.완 개인 대시보드</h1>
            <p>오늘도 운동 완료! 당신의 운동 여정을 확인해보세요</p>
        </div>

        <div id="loginSection" class="login-section">
            <h2>로그인</h2>
            <p>이메일을 입력하여 개인 대시보드를 확인하세요</p>
            <br>
            <input type="email" id="emailInput" placeholder="등록한 이메일을 입력하세요">
            <br><br>
            <button onclick="loadDashboard()">대시보드 보기</button>
            <br><br>
            <p style="color: #666; font-size: 0.9em;">
                * 실제 구글 시트 데이터와 연동되었습니다!<br>
                등록된 이메일로 로그인하여 개인별 운동 현황을 확인하세요
            </p>
        </div>

        <div id="dashboardSection" class="hidden">
            <div class="user-info">
                <div>
                    <h2 id="userName">사용자님</h2>
                    <p id="userEmail"></p>
                </div>
                <div class="streak-badge" id="streakBadge">
                    🔥 3일 연속 운동 중!
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalDays">15</div>
                    <div class="stat-label">총 운동일수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisMonth">8</div>
                    <div class="stat-label">이번 달 운동</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="favoriteExercise">러닝</div>
                    <div class="stat-label">가장 많이 한 운동</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentStreak">3</div>
                    <div class="stat-label">연속 운동일</div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-title">운동 종류별 통계</div>
                    <div class="chart-wrapper">
                        <canvas id="exerciseChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">월별 운동 현황</div>
                    <div class="chart-wrapper">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="recent-activities">
                <div class="chart-title">최근 운동 기록</div>
                <div id="recentActivitiesList">
                    <div class="activity-item">
                        <div>
                            <span class="activity-type">러닝</span>
                            <span style="margin-left: 15px;">오늘 아침 한강에서 5km 달리기</span>
                        </div>
                        <div style="color: #666;">2024-06-19</div>
                    </div>
                    <div class="activity-item">
                        <div>
                            <span class="activity-type">웨이트</span>
                            <span style="margin-left: 15px;">헬스장에서 상체운동 집중</span>
                        </div>
                        <div style="color: #666;">2024-06-18</div>
                    </div>
                    <div class="activity-item">
                        <div>
                            <span class="activity-type">요가</span>
                            <span style="margin-left: 15px;">홈요가 30분 완료</span>
                        </div>
                        <div style="color: #666;">2024-06-17</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script 웹앱 URL (최종 배포된 URL)
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbznELAWoFpoHQ0knouZGh7GDYrNtbVL1HBlV4WXUdSLto9sh_Sdkjj1jvC0MK7yIGh9Gg/exec';
        
        // 샘플 데이터 (Google Apps Script 연동 전 테스트용)
        const sampleData = {
            'user@example.com': {
                name: '김운동',
                totalDays: 15,
                thisMonth: 8,
                favoriteExercise: '러닝',
                currentStreak: 3,
                exerciseTypes: {
                    '러닝': 5,
                    '웨이트 트레이닝': 4,
                    '요가': 3,
                    '걷기': 2,
                    '자전거': 1
                },
                monthlyData: [1, 2],
                recentActivities: [
                    { type: '러닝', date: '2024-06-19', description: '러닝 운동 완료' },
                    { type: '웨이트 트레이닝', date: '2024-06-18', description: '웨이트 트레이닝 운동 완료' },
                    { type: '요가', date: '2024-06-17', description: '요가 운동 완료' }
                ]
            }
        };

        async function loadDashboard() {
            const email = document.getElementById('emailInput').value;
            
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            // 로딩 표시
            const button = document.querySelector('button');
            const originalText = button.textContent;
            button.textContent = '로딩 중...';
            button.disabled = true;

            try {
                let userData;
                
                // Google Apps Script URL이 설정되어 있으면 실제 데이터 가져오기
                if (GAS_WEB_APP_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    userData = await fetchUserData(email);
                } else {
                    // 샘플 데이터 사용
                    userData = sampleData[email] || sampleData['user@example.com'];
                    console.log('샘플 데이터를 사용중입니다. 실제 연동을 위해서는 Google Apps Script URL을 설정해주세요.');
                }

                if (userData.error) {
                    alert(userData.error);
                    return;
                }
                
                // UI 업데이트
                updateDashboardUI(userData, email);
                
            } catch (error) {
                console.error('데이터 로딩 오류:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다. 샘플 데이터로 표시합니다.');
                
                // 오류 시 샘플 데이터 사용
                const userData = sampleData['user@example.com'];
                updateDashboardUI(userData, email);
            } finally {
                // 로딩 완료
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function fetchUserData(email) {
            const response = await fetch(`${GAS_WEB_APP_URL}?email=${encodeURIComponent(email)}`);
            
            if (!response.ok) {
                throw new Error('서버 응답 오류');
            }
            
            return await response.json();
        }

        function updateDashboardUI(userData, email) {
            // UI 표시
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // 데이터 업데이트
            document.getElementById('userName').textContent = userData.name + '님';
            document.getElementById('userEmail').textContent = email;
            document.getElementById('totalDays').textContent = userData.totalDays;
            document.getElementById('thisMonth').textContent = userData.thisMonth;
            document.getElementById('favoriteExercise').textContent = userData.favoriteExercise;
            document.getElementById('currentStreak').textContent = userData.currentStreak;
            document.getElementById('streakBadge').textContent = `🔥 ${userData.currentStreak}일 연속 운동 중!`;

            // 최근 활동 목록 업데이트
            updateRecentActivities(userData.recentActivities);

            // 차트 생성
            createExerciseChart(userData.exerciseTypes);
            createMonthlyChart(userData.monthlyData);
        }

        function updateRecentActivities(activities) {
            const container = document.getElementById('recentActivitiesList');
            container.innerHTML = '';
            
            activities.forEach(activity => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'activity-item';
                activityDiv.innerHTML = `
                    <div>
                        <span class="activity-type">${activity.type}</span>
                        <span style="margin-left: 15px;">${activity.description}</span>
                    </div>
                    <div style="color: #666;">${activity.date}</div>
                `;
                container.appendChild(activityDiv);
            });
        }

        function createExerciseChart(exerciseData) {
            const ctx = document.getElementById('exerciseChart').getContext('2d');
            
            // 기존 차트가 있다면 삭제
            if (window.exerciseChartInstance) {
                window.exerciseChartInstance.destroy();
            }
            
            window.exerciseChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(exerciseData),
                    datasets: [{
                        data: Object.values(exerciseData),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#43e97b',
                            '#fa709a'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyChart(monthlyData) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // 기존 차트가 있다면 삭제
            if (window.monthlyChartInstance) {
                window.monthlyChartInstance.destroy();
            }
            
            // 현재 날짜 기준으로 최근 2개월 라벨 생성
            const today = new Date();
            const labels = [];
            
            for (let i = 1; i >= 0; i--) {
                const targetDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthLabel = targetDate.toLocaleDateString('ko-KR', { month: 'long' });
                labels.push(monthLabel);
            }
            
            console.log('월별 차트 라벨:', labels);
            console.log('월별 차트 데이터:', monthlyData);
            
            window.monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // 동적으로 생성된 라벨 사용
                    datasets: [{
                        label: '월별 운동 횟수',
                        data: monthlyData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                stepSize: 1 // 정수 단위로 표시
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        // 엔터키로 로그인 가능
        document.getElementById('emailInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadDashboard();
            }
        });
    </script>
</body>
</html>
