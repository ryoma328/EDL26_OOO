// Google Apps Script 코드 - 최종 버전
const SPREADSHEET_ID = '1oaHRBv8N4tpeB2ezcKUszaETiC6cOeUm0bD6k8JSUVg';
const SHEET_NAME = '운동인증기록'; // 실제 시트 탭 이름

function doGet(e) {
  const email = e.parameter.email;
  
  if (!email) {
    return ContentService.createTextOutput(
      JSON.stringify({error: '이메일 파라미터가 필요합니다'})
    ).setMimeType(ContentService.MimeType.JSON);
  }
  
  try {
    const userData = getUserExerciseData(email);
    const output = ContentService.createTextOutput(JSON.stringify(userData))
      .setMimeType(ContentService.MimeType.JSON);
    
    // CORS 헤더 설정
    return output;
  } catch (error) {
    console.log('오류 발생:', error.toString());
    return ContentService.createTextOutput(
      JSON.stringify({error: '데이터 처리 중 오류가 발생했습니다: ' + error.toString()})
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

function getUserExerciseData(userEmail) {
  try {
    // 스프레드시트 열기
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('스프레드시트 연결 성공');
    
    // 시트 찾기
    let sheet;
    const possibleNames = ['운동인증기록', '운동 인증 기록', '양식 응답 1', 'Form Responses 1'];
    
    for (let name of possibleNames) {
      try {
        sheet = spreadsheet.getSheetByName(name);
        if (sheet) {
          console.log('시트 찾음:', name);
          break;
        }
      } catch (e) {
        continue;
      }
    }
    
    if (!sheet) {
      // 첫 번째 시트 사용
      sheet = spreadsheet.getSheets()[0];
      console.log('첫 번째 시트 사용:', sheet.getName());
    }
    
    const data = sheet.getDataRange().getValues();
    console.log('데이터 행 수:', data.length);
    
    if (data.length < 2) {
      return {
        error: '시트에 데이터가 없습니다.',
        email: userEmail
      };
    }
    
    // 헤더 행 (첫 번째 행)
    const headers = data[0];
    console.log('헤더:', headers);
    
    // 실제 컬럼 인덱스 (테스트 결과 확인된 구조)
    const timestampCol = 0; // 타임스탬프
    const emailCol = 1;     // 이메일
    const nameCol = 2;      // 이름
    const dateCol = 3;      // 운동 날짜
    const exerciseCol = 4;  // 오늘 어떤 운동을 하셨나요?
    const photoCol = 5;     // 인증사진
    // 컬럼 6: 이메일 주소 (중복)
    
    console.log('실제 헤더명들:');
    headers.forEach((header, index) => {
      console.log(`컬럼 ${index}: ${header}`);
    });
    
    // 사용자 데이터 필터링 (두 개의 이메일 컬럼 모두 확인)
    const userRows = data.slice(1).filter(row => {
      const email1 = row[emailCol]; // 컬럼 1: 이메일
      const email2 = row[6];        // 컬럼 6: 이메일 주소
      
      const checkEmail = (email) => {
        return email && email.toString().toLowerCase().trim() === userEmail.toLowerCase().trim();
      };
      
      return checkEmail(email1) || checkEmail(email2);
    });
    
    console.log('사용자 데이터 수:', userRows.length);
    console.log('필터링에 사용된 이메일:', userEmail);
    
    if (userRows.length === 0) {
      // 디버깅을 위해 시트에 있는 이메일들 확인
      const availableEmails = data.slice(1).map(row => ({
        email1: row[emailCol],
        email2: row[6]
      })).filter(emails => emails.email1 || emails.email2);
      
      console.log('시트에 있는 이메일들:', availableEmails);
      
      return {
        error: '해당 이메일로 등록된 운동 기록이 없습니다.',
        email: userEmail,
        availableEmails: availableEmails.slice(0, 3), // 처음 3개만 반환
        totalRecords: data.length - 1
      };
    }
    
    // 사용자 이름 (첫 번째 기록에서 가져오기)
    const userName = userRows[0][nameCol] || '사용자';
    
    // 운동 통계 계산
    const stats = calculateExerciseStats(userRows, dateCol, exerciseCol);
    
    return {
      name: userName,
      email: userEmail,
      ...stats,
      recentActivities: getRecentActivities(userRows, dateCol, exerciseCol, timestampCol)
    };
    
  } catch (error) {
    console.log('getUserExerciseData 오류:', error.toString());
    throw error;
  }
}

function calculateExerciseStats(userRows, dateCol, exerciseCol) {
  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  
  // 총 운동일수
  const totalDays = userRows.length;
  
  // 이번 달 운동 횟수
  let thisMonth = 0;
  userRows.forEach(row => {
    try {
      const dateStr = row[dateCol];
      if (dateStr) {
        const exerciseDate = parseKoreanDate(dateStr);
        if (exerciseDate && 
            exerciseDate.getMonth() === currentMonth && 
            exerciseDate.getFullYear() === currentYear) {
          thisMonth++;
        }
      }
    } catch (e) {
      console.log('날짜 파싱 오류:', e);
    }
  });
  
  // 운동 종류별 통계
  const exerciseTypes = {};
  userRows.forEach(row => {
    const exercise = row[exerciseCol];
    if (exercise) {
      exerciseTypes[exercise] = (exerciseTypes[exercise] || 0) + 1;
    }
  });
  
  // 가장 많이 한 운동
  const favoriteExercise = Object.keys(exerciseTypes).length > 0 
    ? Object.keys(exerciseTypes).reduce((a, b) => 
        exerciseTypes[a] > exerciseTypes[b] ? a : b
      )
    : '운동';
  
  // 연속 운동일 계산
  const currentStreak = calculateCurrentStreak(userRows, dateCol);
  
  // 월별 데이터 (최근 4개월)
  const monthlyData = calculateMonthlyData(userRows, dateCol);
  
  return {
    totalDays,
    thisMonth,
    favoriteExercise,
    currentStreak,
    exerciseTypes,
    monthlyData
  };
}

function parseKoreanDate(dateStr) {
  try {
    if (!dateStr) return null;
    
    // "2025. 6. 18" 또는 "2025.6.18" 형식 처리
    const cleanStr = dateStr.toString().replace(/\s+/g, ' ').trim();
    
    // 점으로 구분된 형식 처리
    let dateParts = cleanStr.split(/[.\s]+/).filter(part => part.length > 0);
    
    if (dateParts.length >= 3) {
      const year = parseInt(dateParts[0]);
      const month = parseInt(dateParts[1]) - 1; // JavaScript에서 월은 0부터 시작
      const day = parseInt(dateParts[2]);
      
      if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
        return new Date(year, month, day);
      }
    }
    
    // 기본 Date 파싱 시도
    const standardDate = new Date(dateStr);
    if (!isNaN(standardDate.getTime())) {
      return standardDate;
    }
    
    return null;
  } catch (e) {
    console.log('날짜 파싱 실패:', dateStr, e);
    return null;
  }
}

function calculateCurrentStreak(userRows, dateCol) {
  try {
    // 유효한 날짜가 있는 행들만 필터링하고 날짜로 변환
    const datesWithData = [];
    
    userRows.forEach(row => {
      const exerciseDate = parseKoreanDate(row[dateCol]);
      if (exerciseDate) {
        exerciseDate.setHours(0, 0, 0, 0);
        datesWithData.push(exerciseDate.getTime());
      }
    });
    
    if (datesWithData.length === 0) return 1;
    
    // 중복 제거 후 내림차순 정렬
    const uniqueDates = [...new Set(datesWithData)].sort((a, b) => b - a);
    
    let streak = 0;
    let currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < uniqueDates.length; i++) {
      const exerciseDate = new Date(uniqueDates[i]);
      const daysDiff = Math.floor((currentDate - exerciseDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff === streak) {
        streak++;
        currentDate = new Date(exerciseDate);
        currentDate.setDate(currentDate.getDate() - 1);
      } else if (daysDiff === streak + 1 && streak === 0) {
        // 어제 운동한 경우도 연속으로 카운트
        streak++;
        currentDate = new Date(exerciseDate);
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    
    return Math.max(streak, 1);
  } catch (error) {
    console.log('연속일 계산 오류:', error);
    return 1;
  }
}

function calculateMonthlyData(userRows, dateCol) {
  try {
    const monthlyCount = {};
    const today = new Date();
    
    // 최근 4개월 초기화
    for (let i = 3; i >= 0; i--) {
      const targetDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const monthKey = `${targetDate.getFullYear()}-${targetDate.getMonth()}`;
      monthlyCount[monthKey] = 0;
    }
    
    // 운동 기록들을 월별로 카운트
    userRows.forEach(row => {
      const exerciseDate = parseKoreanDate(row[dateCol]);
      if (exerciseDate) {
        const monthKey = `${exerciseDate.getFullYear()}-${exerciseDate.getMonth()}`;
        if (monthlyCount.hasOwnProperty(monthKey)) {
          monthlyCount[monthKey]++;
        }
      }
    });
    
    return Object.values(monthlyCount);
  } catch (error) {
    console.log('월별 데이터 계산 오류:', error);
    return [0, 0, 0, userRows.length];
  }
}

function getRecentActivities(userRows, dateCol, exerciseCol, timestampCol) {
  try {
    // 타임스탬프 기준으로 정렬
    const sortedRows = userRows.sort((a, b) => {
      try {
        const dateA = new Date(a[timestampCol]);
        const dateB = new Date(b[timestampCol]);
        return dateB - dateA; // 최신순
      } catch (e) {
        return 0;
      }
    });
    
    return sortedRows.slice(0, 5).map(row => {
      const exerciseType = row[exerciseCol] || '운동';
      const dateStr = row[dateCol] || '';
      
      // 날짜 형식 변환
      let formattedDate = '';
      const exerciseDate = parseKoreanDate(dateStr);
      if (exerciseDate) {
        const year = exerciseDate.getFullYear();
        const month = String(exerciseDate.getMonth() + 1).padStart(2, '0');
        const day = String(exerciseDate.getDate()).padStart(2, '0');
        formattedDate = `${year}-${month}-${day}`;
      } else {
        formattedDate = new Date().toISOString().split('T')[0];
      }
      
      return {
        type: exerciseType,
        date: formattedDate,
        description: `${exerciseType} 운동 완료`
      };
    });
  } catch (error) {
    console.log('최근 활동 계산 오류:', error);
    return [];
  }
}

// 테스트 함수
function testScript() {
  const testEmail = 'ryoma328@gmail.com'; // 실제 등록된 이메일
  try {
    const result = getUserExerciseData(testEmail);
    console.log('테스트 결과:', JSON.stringify(result, null, 2));
  } catch (error) {
    console.log('테스트 오류:', error.toString());
  }
}

// 디버깅용 함수 - 시트 구조 확인
function debugSheetStructure() {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheets = spreadsheet.getSheets();
    
    console.log('전체 시트 수:', sheets.length);
    sheets.forEach((sheet, index) => {
      console.log(`시트 ${index + 1}: "${sheet.getName()}"`);
    });
    
    // 첫 번째 시트의 데이터 구조 확인
    const sheet = sheets[0];
    const data = sheet.getDataRange().getValues();
    
    console.log('시트 이름:', sheet.getName());
    console.log('데이터 행 수:', data.length);
    console.log('헤더 (첫 번째 행):', data[0]);
    
    if (data.length > 1) {
      console.log('첫 번째 데이터 행:', data[1]);
      console.log('두 번째 데이터 행:', data[2]);
      
      // 운동 날짜 파싱 테스트
      if (data[1] && data[1][3]) {
        console.log('날짜 파싱 테스트:', data[1][3], '->', parseKoreanDate(data[1][3]));
      }
    }
    
  } catch (error) {
    console.log('디버깅 오류:', error.toString());
  }
}
